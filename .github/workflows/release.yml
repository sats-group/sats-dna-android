name: Build and release

on:
  push:
    tags:
      - v*.*.*

jobs:
  build-and-release-lib:
    name: Build and Release Library
    runs-on: buildjet-4vcpu-ubuntu-2204
    timeout-minutes: 45
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4

      - name: Set up JDK 19
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: 19

      - name: Generate Version Name
        run: echo "VERSION_NAME=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')" >> $GITHUB_ENV

      - name: Decode Keystore File
        run: echo $KEYSTORE_FILE_BASE64 | base64 --decode - > $GITHUB_WORKSPACE/play-upload.keystore
        env:
          KEYSTORE_FILE_BASE64: ${{ secrets.PLAY_UPLOAD_KEYSTORE_FILE_BASE64 }}

      - name: Build library
        uses: gradle/gradle-build-action@v2
        with:
          arguments: build
        env:
          SATS_KEYSTORE_FILE: ${{ github.workspace }}/play-upload.keystore
          SATS_KEYSTORE_PASSWORD: ${{ secrets.PLAY_UPLOAD_KEYSTORE_PASSWORD }}
          SATS_KEYSTORE_KEY_ALIAS: ${{ secrets.PLAY_UPLOAD_KEY_ALIAS }}
          SATS_KEYSTORE_KEY_PASSWORD: ${{ secrets.PLAY_UPLOAD_KEY_PASSWORD }}

      - name: Remove Decoded Keystore File
        run: rm $GITHUB_WORKSPACE/play-upload.keystore

      - name: Run tests
        uses: gradle/gradle-build-action@v2
        with:
          arguments: :sats-dna:test

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          generateReleaseNotes: true
          makeLatest: true

      - name: Publish Artifacts
        uses: gradle/gradle-build-action@v2
        with:
          arguments: publish
        env:
          GH_PACKAGES_USERNAME: ${{ secrets.GH_PACKAGES_USERNAME }}
          GH_PACKAGES_PASSWORD: ${{ secrets.GH_PACKAGES_PASSWORD }}

  build-and-release-sample-app:
    name: Build and Release Sample App
    runs-on: buildjet-4vcpu-ubuntu-2204
    timeout-minutes: 45

    steps:
      - name: Checkout Code
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4

      - name: Set up JDK 19
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: 19

      - name: Generate Version Code
        run: echo "VERSION_CODE=$((2 + $GITHUB_RUN_NUMBER))" >> $GITHUB_ENV

      - name: Generate Version Name
        run: echo "VERSION_NAME=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')" >> $GITHUB_ENV

      - name: Run Sample App unit tests
        uses: gradle/gradle-build-action@v2
        with:
          arguments: :sample-app:test

      - name: Decode Keystore File
        run: echo $KEYSTORE_FILE_BASE64 | base64 --decode - > $GITHUB_WORKSPACE/play-upload.keystore
        env:
          KEYSTORE_FILE_BASE64: ${{ secrets.PLAY_UPLOAD_KEYSTORE_FILE_BASE64 }}

      - name: Bundle Sample App
        uses: gradle/gradle-build-action@v2
        with:
          arguments: :sample-app:bundleRelease
        env:
          SATS_KEYSTORE_FILE: ${{ github.workspace }}/play-upload.keystore
          SATS_KEYSTORE_PASSWORD: ${{ secrets.PLAY_UPLOAD_KEYSTORE_PASSWORD }}
          SATS_KEYSTORE_KEY_ALIAS: ${{ secrets.PLAY_UPLOAD_KEY_ALIAS }}
          SATS_KEYSTORE_KEY_PASSWORD: ${{ secrets.PLAY_UPLOAD_KEY_PASSWORD }}

      - name: Remove Decoded Keystore File
        run: rm $GITHUB_WORKSPACE/play-upload.keystore

      - name: Upload Bundle to Play Store
        uses: r0adkll/upload-google-play@v1.1.2
        with:
          releaseFiles: ./sample-app/build/outputs/bundle/release/sample-app-release.aab
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: com.sats.dna.sample
          track: beta
          inAppUpdatePriority: 5
